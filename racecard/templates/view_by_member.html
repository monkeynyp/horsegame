{% extends "master.html" %}
{% block title %} Horse Racing Prediction By Machine Learning and Users {% endblock %}

{% load i18n %}
{% load static %}

{% block og_title %}Tips Summary View{% endblock %}
{% block og_description %}Explore horse racing tips and predictions by users and machine learning models.{% endblock %}
{% block og_image %}{% static 'images/tips-summary-share.jpg' %}{% endblock %}

{% block content %}
<style>
/* --- UI/UX Optimized Styles --- */
.tips-summary-bg {
    background: #f7f9fa;
    min-height: 100vh;
}
.tips-summary-header {
    background: #1976d2;
    color: #fff;
    border-radius: 10px 10px 0 0;
    padding: 24px 0 16px 0;
    margin-bottom: 0;
    box-shadow: 0 2px 12px #e0e0e0;
}
.tips-summary-header h2 {
    margin: 0;
    font-weight: 700;
    letter-spacing: 1px;
}
.tips-summary-tabs {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 12px #e0e0e0;
    margin-bottom: 24px;
    padding: 0;
}
.tips-summary-sidebar {
    background: #e3f2fd;
    border-radius: 10px;
    box-shadow: 0 2px 8px #e0e0e0;
    padding: 18px 0 18px 0;
    margin-bottom: 24px;
}
.tips-summary-sidebar .tablink {
    width: 100%;
    margin-bottom: 6px;
    font-size: 1.1em;
    font-weight: 500;
    border-radius: 30px;
    transition: background 0.2s, color 0.2s;
}
.tips-summary-sidebar .tablink.w3-red,
.tips-summary-sidebar .tablink:focus,
.tips-summary-sidebar .tablink:hover {
    background: #1976d2 !important;
    color: #fff !important;
}
.tips-summary-user-card {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 12px #e0e0e0;
    margin-bottom: 24px;
    padding: 0;
    transition: box-shadow 0.2s;
}
.tips-summary-user-card:hover {
    box-shadow: 0 4px 24px #b3c6e0;
}
.tips-summary-user-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-radius: 10px 10px 0 0;
    padding: 12px 20px;
    font-weight: 600;
    font-size: 1.15em;
    background: #e3f2fd;
}
.tips-summary-user-header .fa-crown {
    margin-left: 8px;
}
.tips-summary-race-info {
    background: #f4f8fb;
    border-radius: 8px;
    margin: 12px 0 12px 0;
    padding: 10px 18px 6px 18px;
}
.tips-summary-horse-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px 0;
    margin-bottom: 0;
}
.tips-summary-horse-list .tips-summary-horse {
    flex: 1 1 33%;
    display: flex;
    align-items: center;
    font-size: 1em;
    margin-bottom: 6px;
}
.tips-summary-horse-list .w3-badge {
    min-width: 28px;
    text-align: center;
    margin-right: 8px;
}
.tips-summary-user-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #e3f2fd;
    border-radius: 0 0 10px 10px;
    padding: 10px 20px;
    font-size: 1em;
}
.tips-summary-support-btn {
    margin: 18px 0 0 0;
    font-size: 1.1em;
    border-radius: 30px;
    padding: 8px 28px;
    font-weight: 600;
    box-shadow: 0 2px 8px #e0e0e0;
    background: #fff8e1;
    color: #d84315;
    transition: background 0.2s, color 0.2s;
}
.tips-summary-support-btn:hover {
    background: #ffd180;
    color: #fff;
}
.tips-summary-share {
    margin-top: 32px;
    margin-bottom: 24px;
}
.tips-summary-share .w3-button {
    margin: 0 8px 8px 0;
    font-size: 1.1em;
    border-radius: 30px;
    font-weight: 600;
    min-width: 140px;
}
@media (max-width: 900px) {
    .w3-quarter, .w3-threequarter, .w3-twothird {
        width: 100% !important;
        float: none !important;
    }
    .tips-summary-user-card {
        margin: 0 0 24px 0 !important;
    }
}
</style>

<div class="tips-summary-bg">
    <div class="tips-summary-header w3-center">
        <a href="/racecard/" class="w3-button w3-white w3-round w3-hover-blue" style="position:absolute;left:24px;top:24px;">
            <i class="fa-solid fa-circle-arrow-left fa-lg"></i>&nbsp;{% trans 'Back to View By Race' %}
        </a>
        <h2>{% trans 'Tips Summary View' %}</h2>
    </div>

    <div class="w3-row-padding w3-margin">
        <div class="w3-quarter tips-summary-sidebar">
            <h6 class="w3-padding w3-light-blue" style="border-radius:8px 8px 0 0;">{% trans 'Select User' %}:</h6>
            {% for user_data in complete_tips_by_user %}
                <button class="w3-bar-item w3-button tablink {% if forloop.counter == 1 %}w3-red{% endif %}" onclick="openTab(event, '{{ user_data.user }}')">
                    <i class="fa-solid fa-user"></i> {{ user_data.user }}
                </button>
            {% endfor %}
        </div>

        <div id="userTabs" class="w3-threequarter">
            {% for user_data in complete_tips_by_user %}
                <div id="{{ user_data.user }}" class="user-record tips-summary-user-card w3-animate-opacity" style="display: none;">
                    {% cycle 'w3-blue' 'w3-green' 'w3-yellow' 'w3-brown' 'w3-indigo' 'w3-lime' 'w3-amber' as color silent %}
                    <div>
                        <div class="tips-summary-user-header {{color}}">
                            <span>
                                <i class="fa-solid fa-user"></i> {{ user_data.user }}
                                {% if forloop.counter == 1 %}
                                    <i class="fa-solid fa-crown" style="color: #FFD43B;" title="Top User"></i>
                                {% elif forloop.counter == 2 %}
                                    <i class="fa-solid fa-crown" style="color: #f6f5f1e9;" title="Second"></i>
                                {% endif %}
                            </span>
                        </div>
                        {% for race_no, records in user_data.records_by_race_no.items %}
                            <div class="tips-summary-race-info">
                                <h5 style="margin:0 0 8px 0;">{% trans 'Race' %} {{ race_no }}</h5>
                                <div class="tips-summary-horse-list">
                                    {% for record in records %}
                                        <div class="tips-summary-horse">
                                            <span class="w3-badge {% if record.hit == 1 %}w3-amber{% else %}w3-light-grey{% endif %}">
                                                {{ record.horse_no }}
                                            </span>
                                            <span>
                                                {% if LANGUAGE_CODE == 'en' %}
                                                    {{ record.horse_name }}
                                                {% elif LANGUAGE_CODE == 'tw' %}
                                                    {{ record.horse_name_cn }}
                                                {% endif %}
                                            </span>
                                            {% if record.hit == 1 %}
                                                <span class="w3-badge w3-red w3-small" style="margin-left:8px;">${{record.dividend}}</span>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                        <div class="tips-summary-user-footer {{color}}">
                            <span>
                                <strong>{% trans 'Current' %}:</strong>
                                {% for last_perf in last_perf_by_user %}
                                    {% if last_perf.user__username == user_data.user.username %}
                                        <span class="w3-tooltip w3-red">{{ last_perf.hit_pst | floatformat:0 }}%
                                            <span class="w3-text">(<em>ðŸ’°${{ last_perf.total_dividend | floatformat:0 }}</em>)</span>
                                        </span>
                                    {% endif %}
                                {% endfor %}
                                &nbsp;|&nbsp;
                                <strong>{% trans 'Total' %}:</strong>
                                {% for score in user_scores %}
                                    {% if score.user == user_data.user %}
                                        {{ score.percentage | floatformat:0 }}%
                                    {% endif %}
                                {% endfor %}
                            </span>
                            <span>
                                {% if user_data.groups_name == "MailList" %}
                                    <i class="fa-solid fa-person fa-xl" title="Human"></i>
                                {% else %}
                                    <i class="fa-solid fa-robot fa-xl" title="Robot"></i>
                                {% endif %}
                            </span>
                        </div>
                        <div class="w3-center">
                            <a href="https://feetheho.com/4/7158523" class="tips-summary-support-btn w3-button w3-hover-orange">
                                <i class="fa-solid fa-heart" style="color: #f01000;"></i> {% trans "Support Monkey" %}
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="w3-center tips-summary-share">
        <h4 style="font-weight:600;">{% trans "Share this page" %}</h4>
        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" class="w3-button w3-blue w3-round w3-hover-indigo">
            <i class="fa-brands fa-facebook-f"></i> Facebook
        </a>
        <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ block.super }}" target="_blank" class="w3-button w3-light-blue w3-round w3-hover-blue">
            <i class="fa-brands fa-twitter"></i> Twitter
        </a>
        <button class="w3-button w3-green w3-round w3-hover-teal" onclick="shareTableDataAsText()">
            <i class="fa-solid fa-share"></i> {% trans "Share Table as Text on Facebook" %}
        </button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    function openTab(evt, userName) {
        var i, x, tablinks;
        x = document.getElementsByClassName("user-record");
        for (i = 0; i < x.length; i++) {
            x[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablink");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" w3-red", "");
        }
        document.getElementById(userName).style.display = "block";
        evt.currentTarget.className += " w3-red";
    }

    // Show the default tab (the first record)
    document.addEventListener("DOMContentLoaded", function() {
        var firstUser = "{{ complete_tips_by_user.0.user }}";
        if (document.getElementById(firstUser)) {
            document.getElementById(firstUser).style.display = "block";
        }
    });

    function shareTableDataAsText() {
        const userTabs = document.getElementById('userTabs');
        if (!userTabs) {
            alert('Content not found!');
            return;
        }
        // Extract the text content from the first user-record only for brevity
        let textContent = '';
        const userRecords = userTabs.querySelectorAll('.user-record');
        if (userRecords.length > 0) {
            textContent = userRecords[0].innerText.trim();
            textContent = textContent.substring(0, 120) + '...';
        }
        if (!textContent.trim()) {
            alert('No content to share!');
            return;
        }
        const encodedText = encodeURIComponent(textContent);
        const facebookShareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodedText}`;
        window.open(facebookShareUrl, '_blank');
    }
</script>
{% endblock %}
